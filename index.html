<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input & Laporan Ekuitas Koperasi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
        }
        
        /* Tab Navigation */
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1px;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f0f4f8;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #3498db;
            color: #2c3e50;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .form-col {
            flex: 1;
            min-width: 200px;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f9f9f9;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .report-table th {
            background: #34495e;
            color: white;
            padding: 15px;
        }
        
        .report-table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
        }
        
        .text-right {
            text-align: right;
        }
        
        .positive {
            color: #27ae60;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        .total-row {
            background: #2c3e50;
            color: white;
            font-weight: bold;
        }
        
        .export-options {
            margin-top: 20px;
            padding: 20px;
            background: #f0f4f8;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="margin-bottom: 20px; color: #2c3e50;">
            <i class="fas fa-hand-holding-usd"></i> 
            Sistem Laporan Perubahan Ekuitas Koperasi
        </h1>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab active" onclick="openTab('input')">ðŸ“¥ INPUT TRANSAKSI</div>
            <div class="tab" onclick="openTab('data')">ðŸ“‹ DATA MASTER</div>
            <div class="tab" onclick="openTab('report')">ðŸ“Š LAPORAN EKUITAS</div>
            <div class="tab" onclick="openTab('export')">ðŸ’¾ EXPORT/IMPORT</div>
        </div>
        
        <!-- TAB 1: INPUT TRANSAKSI -->
        <div id="input" class="tab-content active">
            <h2 style="margin-bottom: 20px;">Form Input Transaksi Bulanan</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="card">
                        <h3><i class="fas fa-users"></i> 1. Transaksi Modal</h3>
                        <div class="form-group">
                            <label>Jenis Transaksi</label>
                            <select id="modalJenis" class="form-control">
                                <option value="tambah">+ Tambah Modal (Anggota Baru)</option>
                                <option value="tambah_wajib">+ Simpanan Wajib</option>
                                <option value="tambah_sukarela">+ Simpanan Sukarela</option>
                                <option value="kurang">- Pengembalian Modal</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>Tanggal</label>
                                <input type="date" id="modalTanggal" class="form-control" value="2024-03-15">
                            </div>
                            <div class="form-col">
                                <label>Jumlah (Rp)</label>
                                <input type="number" id="modalJumlah" class="form-control" placeholder="1000000">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Keterangan</label>
                            <input type="text" id="modalKeterangan" class="form-control" placeholder="Contoh: 3 anggota baru">
                        </div>
                        <button class="btn btn-primary" onclick="tambahModal()">
                            <i class="fas fa-plus"></i> Tambah Transaksi Modal
                        </button>
                    </div>
                </div>
                
                <div class="form-col">
                    <div class="card">
                        <h3><i class="fas fa-chart-pie"></i> 2. Input SHU Bulanan</h3>
                        <div class="form-row">
                            <div class="form-col">
                                <label>Bulan</label>
                                <select id="shuBulan" class="form-control">
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3" selected>Maret</option>
                                    <option value="4">April</option>
                                    <option value="5">Mei</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">Agustus</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>Tahun</label>
                                <input type="number" id="shuTahun" class="form-control" value="2024">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Jumlah SHU (Rp)</label>
                            <input type="number" id="shuJumlah" class="form-control" placeholder="5200000">
                        </div>
                        <div class="form-group">
                            <label>Sumber/Keterangan</label>
                            <input type="text" id="shuKeterangan" class="form-control" value="Laba Usaha">
                        </div>
                        <button class="btn btn-primary" onclick="tambahSHU()">
                            <i class="fas fa-plus"></i> Input SHU Bulan Ini
                        </button>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3><i class="fas fa-money-bill-wave"></i> 3. Input Prive (Pengambilan)</h3>
                        <div class="form-row">
                            <div class="form-col">
                                <label>Tanggal</label>
                                <input type="date" id="priveTanggal" class="form-control" value="2024-03-20">
                            </div>
                            <div class="form-col">
                                <label>Jumlah (Rp)</label>
                                <input type="number" id="priveJumlah" class="form-control" placeholder="1800000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>Nama Pengambil</label>
                                <input type="text" id="priveNama" class="form-control" placeholder="Budi">
                            </div>
                            <div class="form-col">
                                <label>Keperluan</label>
                                <input type="text" id="priveKeperluan" class="form-control" placeholder="Dinas lapangan">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="tambahPrive()">
                            <i class="fas fa-plus"></i> Tambah Prive
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3><i class="fas fa-history"></i> Riwayat Transaksi Hari Ini</h3>
                <table class="data-table" id="riwayatTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Jenis</th>
                            <th>Keterangan</th>
                            <th>Jumlah</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="riwayatBody">
                        <!-- Akan diisi JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- TAB 2: DATA MASTER -->
        <div id="data" class="tab-content">
            <h2 style="margin-bottom: 20px;">Data Master & Saldo Awal</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="card">
                        <h3>ðŸ“Œ Saldo Awal Tahun 2024</h3>
                        <div class="form-group">
                            <label>Modal Anggota (1 Jan 2024)</label>
                            <input type="number" id="masterModalAwal" class="form-control" value="120000000">
                        </div>
                        <div class="form-group">
                            <label>Cadangan Koperasi</label>
                            <input type="number" id="masterCadangan" class="form-control" value="30000000">
                        </div>
                        <div class="form-group">
                            <label>SHU Tahun Lalu (Belum Dibagi)</label>
                            <input type="number" id="masterSHULalu" class="form-control" value="10000000">
                        </div>
                        <button class="btn btn-success" onclick="simpanMaster()">
                            <i class="fas fa-save"></i> Simpan Data Master
                        </button>
                    </div>
                </div>
                
                <div class="form-col">
                    <div class="card">
                        <h3>ðŸ“Š Rekapitulasi per Bulan</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bulan</th>
                                    <th>Modal</th>
                                    <th>SHU</th>
                                    <th>Prive</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="rekapBulananBody">
                                <!-- Akan diisi JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: LAPORAN EKUITAS -->
        <div id="report" class="tab-content">
            <div class="report-header">
                <h2>KOPERASI "SEJAHTERA BERSAMA"</h2>
                <h3>LAPORAN PERUBAHAN EKUITAS</h3>
                <p id="reportPeriode">Untuk Bulan yang Berakhir pada 31 Maret 2024</p>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <select id="reportBulan" class="form-control" style="width: 200px;">
                    <option value="1">Januari</option>
                    <option value="2">Februari</option>
                    <option value="3" selected>Maret</option>
                    <option value="4">April</option>
                    <option value="5">Mei</option>
                    <option value="6">Juni</option>
                    <option value="7">Juli</option>
                    <option value="8">Agustus</option>
                    <option value="9">September</option>
                    <option value="10">Oktober</option>
                    <option value="11">November</option>
                    <option value="12">Desember</option>
                </select>
                <input type="number" id="reportTahun" class="form-control" style="width: 100px;" value="2024">
                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-sync-alt"></i> Tampilkan Laporan
                </button>
            </div>
            
            <div id="laporanContainer">
                <!-- Akan diisi JavaScript -->
            </div>
        </div>
        
        <!-- TAB 4: EXPORT/IMPORT -->
        <div id="export" class="tab-content">
            <h2 style="margin-bottom: 20px;">Export & Import Data</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="card">
                        <h3>ðŸ“¤ Export ke Excel</h3>
                        <p style="margin-bottom: 15px;">Download data dalam format Excel (.xlsx) atau CSV</p>
                        <button class="btn btn-success" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Download Excel (.xlsx)
                        </button>
                        <button class="btn btn-primary" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i> Download CSV
                        </button>
                        <button class="btn btn-warning" onclick="exportToJSON()">
                            <i class="fas fa-file-code"></i> Download JSON
                        </button>
                    </div>
                </div>
                
                <div class="form-col">
                    <div class="card">
                        <h3>ðŸ“¥ Import dari Excel</h3>
                        <p style="margin-bottom: 15px;">Upload file Excel/CSV untuk update data</p>
                        <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls, .json" class="form-control">
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="importFile()">
                            <i class="fas fa-upload"></i> Upload & Proses
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>ðŸ’¾ Backup & Restore</h3>
                <div class="form-row">
                    <div class="form-col">
                        <button class="btn btn-danger" onclick="backupData()">
                            <i class="fas fa-database"></i> Backup Semua Data
                        </button>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-warning" onclick="restoreData()">
                            <i class="fas fa-undo"></i> Restore dari Backup
                        </button>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-secondary" onclick="resetData()">
                            <i class="fas fa-trash"></i> Reset ke Data Awal
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="importResult" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    <script src="https://kit.fontawesome.com/3a2b3f4e5d.js" crossorigin="anonymous"></script>
    <script>
        // ==================== DATA STORAGE ====================
        // Data akan tersimpan di localStorage browser
        let appData = {
            master: {
                modalAwal: 120000000,
                cadangan: 30000000,
                shuLalu: 10000000
            },
            transaksi: {
                modal: [],
                shu: [],
                prive: []
            },
            tahun: 2024
        };
        
        // Load data dari localStorage saat halaman dibuka
        if (localStorage.getItem('koperasiEkuitas')) {
            appData = JSON.parse(localStorage.getItem('koperasiEkuitas'));
        } else {
            // Data contoh
            appData.transaksi.modal = [
                { tanggal: '2024-01-15', jenis: 'tambah', keterangan: '5 Anggota Baru', jumlah: 5000000, bulan: 1 },
                { tanggal: '2024-01-20', jenis: 'tambah_wajib', keterangan: 'Simpanan Wajib', jumlah: 1000000, bulan: 1 },
                { tanggal: '2024-02-10', jenis: 'tambah', keterangan: '2 Anggota Baru', jumlah: 2000000, bulan: 2 },
                { tanggal: '2024-02-15', jenis: 'tambah_wajib', keterangan: 'Simpanan Wajib', jumlah: 500000, bulan: 2 },
                { tanggal: '2024-03-05', jenis: 'tambah', keterangan: '3 Anggota Baru', jumlah: 3000000, bulan: 3 },
                { tanggal: '2024-03-20', jenis: 'tambah_wajib', keterangan: 'Simpanan Wajib', jumlah: 500000, bulan: 3 }
            ];
            
            appData.transaksi.shu = [
                { bulan: 1, tahun: 2024, jumlah: 8000000, keterangan: 'Laba Usaha' },
                { bulan: 2, tahun: 2024, jumlah: 2500000, keterangan: 'Laba Usaha' },
                { bulan: 3, tahun: 2024, jumlah: 5200000, keterangan: 'Laba Usaha' }
            ];
            
            appData.transaksi.prive = [
                { tanggal: '2024-01-25', nama: 'Budi', keperluan: 'Dinas Lapangan', jumlah: 1500000, bulan: 1 },
                { tanggal: '2024-01-28', nama: 'Sari', keperluan: 'Transport Rapat', jumlah: 500000, bulan: 1 },
                { tanggal: '2024-02-15', nama: 'Budi', keperluan: 'Pembelian ATK', jumlah: 500000, bulan: 2 },
                { tanggal: '2024-03-20', nama: 'Andi', keperluan: 'Perjalanan Dinas', jumlah: 1800000, bulan: 3 }
            ];
            
            localStorage.setItem('koperasiEkuitas', JSON.stringify(appData));
        }
        
        // ==================== FUNGSI UTILITY ====================
        function formatRupiah(angka) {
            if (angka === undefined || angka === null) return 'Rp 0';
            if (angka >= 0) {
                return 'Rp ' + angka.toLocaleString('id-ID');
            } else {
                return '(Rp ' + Math.abs(angka).toLocaleString('id-ID') + ')';
            }
        }
        
        function getNamaBulan(bulan) {
            const bulanArr = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return bulanArr[bulan - 1];
        }
        
        // ==================== FUNGSI INPUT TRANSAKSI ====================
        function tambahModal() {
            const jenis = document.getElementById('modalJenis').value;
            const tanggal = document.getElementById('modalTanggal').value;
            const jumlah = parseInt(document.getElementById('modalJumlah').value);
            const keterangan = document.getElementById('modalKeterangan').value;
            const bulan = new Date(tanggal).getMonth() + 1;
            
            if (!jumlah || jumlah <= 0) {
                alert('Masukkan jumlah yang valid!');
                return;
            }
            
            const transaksi = {
                tanggal: tanggal,
                jenis: jenis,
                keterangan: keterangan,
                jumlah: jumlah,
                bulan: bulan
            };
            
            appData.transaksi.modal.push(transaksi);
            localStorage.setItem('koperasiEkuitas', JSON.stringify(appData));
            
            // Reset form
            document.getElementById('modalJumlah').value = '';
            document.getElementById('modalKeterangan').value = '';
            
            alert('Transaksi modal berhasil ditambahkan!');
            updateRiwayat();
            updateRekap();
        }
        
        function tambahSHU() {
            const bulan = parseInt(document.getElementById('shuBulan').value);
            const tahun = parseInt(document.getElementById('shuTahun').value);
            const jumlah = parseInt(document.getElementById('shuJumlah').value);
            const keterangan = document.getElementById('shuKeterangan').value;
            
            if (!jumlah || jumlah <= 0) {
                alert('Masukkan jumlah SHU yang valid!');
                return;
            }
            
            // Cek apakah sudah ada SHU untuk bulan ini
            const existing = appData.transaksi.shu.find(s => s.bulan === bulan && s.tahun === tahun);
            if (existing) {
                if (!confirm(`SHU bulan ${getNamaBulan(bulan)} sudah ada (Rp ${existing.jumlah.toLocaleString()}). Timpa?`)) {
                    return;
                }
                // Hapus yang lama
                const index = appData.transaksi.shu.findIndex(s => s.bulan === bulan && s.tahun === tahun);
                appData.transaksi.shu.splice(index, 1);
            }
            
            appData.transaksi.shu.push({
                bulan: bulan,
                tahun: tahun,
                jumlah: jumlah,
                keterangan: keterangan
            });
            
            localStorage.setItem('koperasiEkuitas', JSON.stringify(appData));
            
            document.getElementById('shuJumlah').value = '';
            alert('SHU berhasil diinput!');
            updateRiwayat();
            updateRekap();
        }
        
        function tambahPrive() {
            const tanggal = document.getElementById('priveTanggal').value;
            const jumlah = parseInt(document.getElementById('priveJumlah').value);
            const nama = document.getElementById('priveNama').value;
            const keperluan = document.getElementById('priveKeperluan').value;
            const bulan = new Date(tanggal).getMonth() + 1;
            
            if (!jumlah || jumlah <= 0) {
                alert('Masukkan jumlah yang valid!');
                return;
            }
            
            appData.transaksi.prive.push({
                tanggal: tanggal,
                nama: nama,
                keperluan: keperluan,
                jumlah: jumlah,
                bulan: bulan
            });
            
            localStorage.setItem('koperasiEkuitas', JSON.stringify(appData));
            
            document.getElementById('priveJumlah').value = '';
            document.getElementById('priveNama').value = '';
            document.getElementById('priveKeperluan').value = '';
            
            alert('Transaksi prive berhasil ditambahkan!');
            updateRiwayat();
            updateRekap();
        }
        
        // ==================== FUNGSI HITUNG ====================
        function hitungTotalModal(sampaiBulan = 12) {
            let total = appData.master.modalAwal;
            appData.transaksi.modal.forEach(m => {
                if (m.bulan <= sampaiBulan) {
                    if (m.jenis.includes('tambah')) {
                        total += m.jumlah;
                    } else {
                        total -= m.jumlah;
                    }
                }
            });
            return total;
        }
        
        function hitungSHUAkumulasi(sampaiBulan = 12) {
            let total = 0;
            appData.transaksi.shu.forEach(s => {
                if (s.bulan <= sampaiBulan && s.tahun === appData.tahun) {
                    total += s.jumlah;
                }
            });
            return total;
        }
        
        function hitungPriveAkumulasi(sampaiBulan = 12) {
            let total = 0;
            appData.transaksi.prive.forEach(p => {
                if (p.bulan <= sampaiBulan) {
                    total += p.jumlah;
                }
            });
            return total;
        }
        
        function hitungTotalEkuitas(bulan) {
            const modal = hitungTotalModal(bulan);
            const cadangan = appData.master.cadangan;
            const shuLalu = appData.master.shuLalu;
            const shuBerjalan = hitungSHUAkumulasi(bulan);
            const prive = hitungPriveAkumulasi(bulan);
            
            return modal + cadangan + shuLalu + shuBerjalan - prive;
        }
        
        // ==================== UPDATE TAMPILAN ====================
        function updateRiwayat() {
            const tbody = document.getElementById('riwayatBody');
            if (!tbody) return;
            
            let html = '';
            
            // Gabungkan semua transaksi
            const semuaTransaksi = [];
            
            appData.transaksi.modal.forEach(m => {
                semuaTransaksi.push({
                    tanggal: m.tanggal,
                    jenis: 'Modal',
                    keterangan: m.keterangan,
                    jumlah: m.jumlah,
                    tipe: 'tambah'
                });
            });
            
            appData.transaksi.shu.forEach(s => {
                semuaTransaksi.push({
                    tanggal: `${s.tahun}-${s.bulan.toString().padStart(2, '0')}-01`,
                    jenis: 'SHU',
                    keterangan: `${getNamaBulan(s.bulan)} ${s.tahun} - ${s.keterangan}`,
                    jumlah: s.jumlah,
                    tipe: 'tambah'
                });
            });
            
            appData.transaksi.prive.forEach(p => {
                semuaTransaksi.push({
                    tanggal: p.tanggal,
                    jenis: 'Prive',
                    keterangan: `${p.nama} - ${p.keperluan}`,
                    jumlah: p.jumlah,
                    tipe: 'kurang'
                });
            });
            
            // Urutkan berdasarkan tanggal (terbaru di atas)
            semuaTransaksi.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            // Ambil 10 terbaru
            semuaTransaksi.slice(0, 10).forEach(t => {
                html += `<tr>
                    <td>${t.tanggal}</td>
                    <td>${t.jenis}</td>
                    <td>${t.keterangan}</td>
                    <td class="${t.tipe === 'tambah' ? 'positive' : 'negative'}">${formatRupiah(t.jumlah)}</td>
                    <td><button class="btn btn-danger btn-small" onclick="hapusTransaksi('${t.tanggal}', '${t.jenis}', ${t.jumlah})">Hapus</button></td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }
        
        function updateRekap() {
            const tbody = document.getElementById('rekapBulananBody');
            if (!tbody) return;
            
            let html = '';
            
            for (let i = 1; i <= 3; i++) {
                const modal = hitungTotalModal(i);
                const shu = hitungSHUAkumulasi(i);
                const prive = hitungPriveAkumulasi(i);
                const total = hitungTotalEkuitas(i);
                
                html += `<tr>
                    <td>${getNamaBulan(i)}</td>
                    <td class="text-right">${formatRupiah(modal)}</td>
                    <td class="text-right positive">${formatRupiah(shu)}</td>
                    <td class="text-right negative">${formatRupiah(prive)}</td>
                    <td class="text-right"><strong>${formatRupiah(total)}</strong></td>
                </tr>`;
            }
            
            tbody.innerHTML = html;
        }
        
        // ==================== GENERATE LAPORAN ====================
        function generateReport() {
            const bulan = parseInt(document.getElementById('reportBulan').value);
            const tahun = document.getElementById('reportTahun').value;
            const container = document.getElementById('laporanContainer');
            
            const namaBulan = getNamaBulan(bulan);
            document.getElementById('reportPeriode').innerHTML = `Untuk Bulan yang Berakhir pada 31 ${namaBulan} ${tahun}`;
            
            // Hitung data
            const saldoAwalModal = bulan === 1 ? appData.master.modalAwal : hitungTotalModal(bulan - 1);
            const saldoAwalSHU = bulan === 1 ? 0 : hitungSHUAkumulasi(bulan - 1);
            const saldoAwalPrive = bulan === 1 ? 0 : hitungPriveAkumulasi(bulan - 1);
            const saldoAwalTotal = bulan === 1 ? 
                (appData.master.modalAwal + appData.master.cadangan + appData.master.shuLalu) : 
                hitungTotalEkuitas(bulan - 1);
            
            // Transaksi bulan ini
            let tambahModalBulanIni = 0;
            appData.transaksi.modal.forEach(m => {
                if (m.bulan === bulan && m.jenis.includes('tambah')) tambahModalBulanIni += m.jumlah;
            });
            
            let shuBulanIni = 0;
            appData.transaksi.shu.forEach(s => {
                if (s.bulan === bulan && s.tahun === appData.tahun) shuBulanIni = s.jumlah;
            });
            
            let priveBulanIni = 0;
            appData.transaksi.prive.forEach(p => {
                if (p.bulan === bulan) priveBulanIni += p.jumlah;
            });
            
            const totalPerubahan = tambahModalBulanIni + shuBulanIni - priveBulanIni;
            
            // Saldo akhir
            const saldoAkhirModal = saldoAwalModal + tambahModalBulanIni;
            const saldoAkhirSHU = saldoAwalSHU + shuBulanIni;
            const saldoAkhirPrive = saldoAwalPrive + priveBulanIni;
            const saldoAkhirTotal = saldoAwalTotal + totalPerubahan;
            
            const html = `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th width="40%">DESKRIPSI</th>
                            <th width="15%">MODAL</th>
                            <th width="15%">SHU BERJALAN</th>
                            <th width="15%">PRIVE</th>
                            <th width="15%">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Saldo Awal, 1 ${namaBulan} ${tahun}</strong></td>
                            <td class="text-right">${formatRupiah(saldoAwalModal)}</td>
                            <td class="text-right ${saldoAwalSHU >= 0 ? 'positive' : 'negative'}">${formatRupiah(saldoAwalSHU)}</td>
                            <td class="text-right ${saldoAwalPrive >= 0 ? 'positive' : 'negative'}">${formatRupiah(saldoAwalPrive)}</td>
                            <td class="text-right"><strong>${formatRupiah(saldoAwalTotal)}</strong></td>
                        </tr>
                        
                        <tr style="background-color: #f8f9fa;">
                            <td colspan="5" style="padding: 15px; font-weight: bold;">
                                PERUBAHAN SELAMA ${namaBulan.toUpperCase()} ${tahun}
                            </td>
                        </tr>
                        
                        <tr>
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;â€¢ Penambahan Modal</td>
                            <td class="text-right positive">${formatRupiah(tambahModalBulanIni)}</td>
                            <td class="text-right">-</td>
                            <td class="text-right">-</td>
                            <td class="text-right positive">${formatRupiah(tambahModalBulanIni)}</td>
                        </tr>
                        
                        <tr>
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;â€¢ SHU Bulan ${namaBulan}</td>
                            <td class="text-right">-</td>
                            <td class="text-right positive">${formatRupiah(shuBulanIni)}</td>
                            <td class="text-right">-</td>
                            <td class="text-right positive">${formatRupiah(shuBulanIni)}</td>
                        </tr>
                        
                        <tr>
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;â€¢ Pengambilan Prive</td>
                            <td class="text-right">-</td>
                            <td class="text-right">-</td>
                            <td class="text-right negative">${formatRupiah(priveBulanIni)}</td>
                            <td class="text-right negative">${formatRupiah(-priveBulanIni)}</td>
                        </tr>
                        
                        <tr style="background-color: #e8f4f8;">
                            <td><strong>Total Perubahan ${namaBulan} ${tahun}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(tambahModalBulanIni)}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(shuBulanIni)}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(-priveBulanIni)}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(totalPerubahan)}</strong></td>
                        </tr>
                        
                        <tr class="total-row">
                            <td><strong>SALDO AKHIR, 31 ${namaBulan.toUpperCase()} ${tahun}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(saldoAkhirModal)}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(saldoAkhirSHU)}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(saldoAkhirPrive)}</strong></td>
                            <td class="text-right"><strong>${formatRupiah(saldoAkhirTotal)}</strong></td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding: 20px; background-color: #f0f4f8; border-radius: 8px;">
                    <h4>ðŸ“‹ RINGKASAN EKUITAS PER ${namaBulan.toUpperCase()} ${tahun}</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="background-color: #e8f5e9; padding: 15px; border-radius: 6px;">
                                <div style="font-size: 14px; color: #555;">Modal Anggota</div>
                                <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${formatRupiah(saldoAkhirModal)}</div>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <div style="background-color: #fff3e0; padding: 15px; border-radius: 6px;">
                                <div style="font-size: 14px; color: #555;">Cadangan</div>
                                <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${formatRupiah(appData.master.cadangan)}</div>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <div style="background-color: #e3f2fd; padding: 15px; border-radius: 6px;">
                                <div style="font-size: 14px; color: #555;">SHU Berjalan</div>
                                <div style="font-size: 24px; font-weight: bold; color: #2980b9;">${formatRupiah(saldoAkhirSHU)}</div>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <div style="background-color: #ffebee; padding: 15px; border-radius: 6px;">
                                <div style="font-size: 14px; color: #555;">Prive (Akumulasi)</div>
                                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${formatRupiah(saldoAkhirPrive)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ==================== EXPORT FUNCTIONS ====================
        function exportToExcel() {
            // Simulasi export Excel
            let csv = "Tanggal,Jenis Transaksi,Keterangan,Jumlah\n";
            
            appData.transaksi.modal.forEach(m => {
                csv += `${m.tanggal},Modal,${m.keterangan},${m.jumlah}\n`;
            });
            
            appData.transaksi.shu.forEach(s => {
                csv += `${s.tahun}-${s.bulan},SHU,${s.keterangan},${s.jumlah}\n`;
            });
            
            appData.transaksi.prive.forEach(p => {
                csv += `${p.tanggal},Prive,${p.nama} - ${p.keperluan},${p.jumlah}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ekuitas_koperasi_${appData.tahun}.csv`;
            a.click();
            
            alert('File CSV berhasil didownload. Buka dengan Excel!');
        }
        
        function exportToCSV() {
            exportToExcel(); // Sama untuk demo
        }
        
        function exportToJSON() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ekuitas_koperasi_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            
            alert('Backup JSON berhasil didownload!');
        }
        
        function backupData() {
            exportToJSON();
        }
        
        function restoreData() {
            const data = localStorage.getItem('koperasiEkuitas');
            if (data) {
                appData = JSON.parse(data);
                updateRiwayat();
                updateRekap();
                generateReport();
                alert('Data berhasil direstore!');
            } else {
                alert('Tidak ada backup tersedia!');
            }
        }
        
        function resetData() {
            if (confirm('Yakin reset ke data awal? Semua transaksi yang sudah diinput akan hilang!')) {
                localStorage.removeItem('koperasiEkuitas');
                location.reload();
            }
        }
        
        function importFile() {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file terlebih dahulu!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Untuk demo, kita asumsikan file JSON
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.master && importedData.transaksi) {
                        appData = importedData;
                        localStorage.setItem('koperasiEkuitas', JSON.stringify(appData));
                        alert('Data berhasil diimport!');
                        location.reload();
                    } else {
                        alert('Format file tidak sesuai!');
                    }
                } catch {
                    alert('File tidak dapat diproses. Gunakan format JSON dari hasil export.');
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                alert('Upload file JSON yang diexport dari sistem ini.');
            }
        }
        
        // ==================== TAB NAVIGATION ====================
        function openTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Update konten tab yang dibuka
            if (tabName === 'report') {
                generateReport();
            } else if (tabName === 'data') {
                updateRekap();
                // Set nilai input master
                document.getElementById('masterModalAwal').value = appData.master.modalAwal;
                document.getElementById('masterCadangan').value = appData.master.cadangan;
                document.getElementById('masterSHULalu').value = appData.master.shuLalu;
            } else if (tabName === 'input') {
                updateRiwayat();
            }
        }
        
        // ==================== FUNGSI LAINNYA ====================
        function simpanMaster() {
            appData.master.modalAwal = parseInt(document.getElementById('masterModalAwal').value);
            appData.master.cadangan = parseInt(document.getElementById('masterCadangan').value);
            appData.master.shuLalu = parseInt(document.getElementById('masterSHULalu').value);
            
            localStorage.setItem('koperasiEkuitas', JSON.stringify(appData));
            alert('Data master berhasil disimpan!');
            updateRekap();
        }
        
        function hapusTransaksi(tanggal, jenis, jumlah) {
            if (confirm(`Hapus transaksi ini?\n${tanggal} - ${jenis} - ${formatRupiah(jumlah)}`)) {
                // Cari dan hapus dari array
                if (jenis === 'Modal') {
                    const index = appData.transaksi.modal.findIndex(m => m.tanggal === tanggal && m.jumlah === jumlah);
                    if (index !== -1) appData.transaksi.modal.splice(index, 1);
                } else if (jenis === 'SHU') {
                    const index = appData.transaksi.shu.findIndex(s => s.jumlah === jumlah);
                    if (index !== -1) appData.transaksi.shu.splice(index, 1);
                } else if (jenis === 'Prive') {
                    const index = appData.transaksi.prive.findIndex(p => p.tanggal === tanggal && p.jumlah === jumlah);
                    if (index !== -1) appData.transaksi.prive.splice(index, 1);
                }
                
                localStorage.setItem('koperasiEkuitas', JSON.stringify(appData));
                updateRiwayat();
                updateRekap();
                alert('Transaksi dihapus!');
            }
        }
        
        // Initialize
        updateRiwayat();
        updateRekap();
        generateReport();
    </script>
</body>
</html>
